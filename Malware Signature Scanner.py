import hashlib

# Base Class: Represents a generic file to be scanned
class Sample:
    def __init__(self, filename, content):
        self.filename = filename
        self.content = content
        self.file_hash = hashlib.md5(content.encode()).hexdigest()

# Abstract Base Class for Detection Engines
class DetectionModule:
    def __init__(self, name):
        self.name = name

    def scan(self, sample):
        # To be overridden by specific detection methods
        return False, "Clean"

# Polymorphism: Signature-based Detection
class SignatureScanner(DetectionModule):
    def __init__(self, name, known_hashes):
        super().__init__(name)
        self.known_hashes = known_hashes

    def scan(self, sample):
        if sample.file_hash in self.known_hashes:
            return True, f"Matched known malware signature: {self.known_hashes[sample.file_hash]}"
        return False, "No signature match."

# Polymorphism: Heuristic (Pattern) Detection
class HeuristicScanner(DetectionModule):
    def __init__(self, name, malicious_strings):
        super().__init__(name)
        self.malicious_strings = malicious_strings

    def scan(self, sample):
        for pattern in self.malicious_strings:
            if pattern in sample.content:
                return True, f"Suspicious code pattern detected: '{pattern}'"
        return False, "No suspicious patterns."

# The AV Engine: Manages multiple modules (Composition)
class AntivirusEngine:
    def __init__(self):
        self.modules = []

    def add_module(self, module):
        self.modules.append(module)

    def analyze(self, sample):
        print(f"\n[ANALYSIS] Scanning: {sample.filename} ({sample.file_hash})")
        threats_found = 0
        
        for module in self.modules:
            is_malicious, message = module.scan(sample)
            if is_malicious:
                print(f"  [!] ALERT [{module.name}]: {message}")
                threats_found += 1
        
        if threats_found == 0:
            print("  [OK] No threats detected by any module.")

def main():
    # Database of known bad hashes
    malware_db = {"44d88612aa8a613c51bd3921d9c6d474": "Trojan.Generic.XP"}
    # Database of suspicious code patterns
    bad_strings = ["eval(base64_decode", "os.system('rm -rf /')", "socket.connect"]

    # Initialize Engine
    av = AntivirusEngine()
    av.add_module(SignatureScanner("MD5-Signatures", malware_db))
    av.add_module(HeuristicScanner("Heuristic-Analyzer", bad_strings))

    # Test Samples
    file1 = Sample("invoice.pdf", "Hello, please find the invoice attached.")
    file2 = Sample("update.py", "import os; os.system('rm -rf /')") # Pattern threat
    file3 = Sample("virus.exe", "test_malware_content") # Hash matches 'malware_db'

    print("--- OOPS Anti-Malware Research Lab ---")
    for f in [file1, file2, file3]:
        av.analyze(f)

if __name__ == "__main__":
    main()